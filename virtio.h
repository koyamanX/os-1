#ifndef VIRTIO_H
#define VIRTIO_H

#include "types.h"

enum {
	MAGIC_VALUE=0x000,
	VERSION=0x004,
	DEVICE_ID=0x008,
	VENDOR_ID=0x00c,
	DEVICE_FEATURES=0x010,
	DEVICE_FEATURES_SEL=0x014,
	DRIVER_FEATURE=0x020,
	DRIVER_FEATURE_SEL=0x024,
	QUEUE_SEL=0x030,
	QUEUE_NUM_MAX=0x034,
	QUEUE_NUM=0x038,
	QUEUE_READY=0x044,
	QUEUE_NOTIFY=0x050,
	INTERRUPT_STATUS=0x060,
	INTERRUPT_ACK=0x064,
	STATUS=0x070,
	QUEUE_DESC_LOW=0x080,
	QUEUE_DESC_HIGH=0x084,
	QUEUE_DRIVER_LOW=0x090,
	QUEUE_DRIVER_HIGH=0x094,
	QUEUE_DEVICE_LOW=0x0a0,
	QUEUE_DEVICE_HIGH=0x0a4,
	CONFIG_GENERATION=0x0fc,
	CONFIG=0x100,
};

#define VIRTIO_BASE 0x10001000
#define VIRTIO_OFFSET(offset) ((volatile u32 *)((VIRTIO_BASE)+(offset)))

#define VIRTIO_MAGIC_VALUE 0x74726976
#define VIRTIO_BLOCK_DEVICE 0x2
#define VIRTIO_VERSION 0x2

#define VIRTIO_STATUS_ACKNOWLEDGE 1
#define VIRTIO_STATUS_DRIVER 2
#define VIRTIO_STATUS_FAILED 128
#define VIRTIO_STATUS_FEATURES_OK 8
#define VIRTIO_STATUS_DRIVER_OK 4
#define VIRTIO_STATUS_DEVICE_NEEDS_RESET 64

#define VIRTIO_BLK_F_RO 5

typedef struct {
	void *desc;
	void *avail;
	void *used;
} block_device_t;

extern block_device_t block_device;

#define QUEUE_SIZE 8

void virtio_init(void);

#endif
